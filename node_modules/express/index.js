/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict';

module.exports = require('./lib/express');


var express = require('express');
var path = require('path');
var bodyParser = require('body-parser');
var comp = require('./lib/router/comp')
var app = express();
var router = express.Router();
const https = require('https');

const custID = '009637816073108880163:nfsysoqnztc';
const key = 'AIzaSyBXGkVilmqEN0KSDAaQy1BlVVIA8r4nS6w';
var names = [];
var returnObj = {};
var time = 1000;

function data(name, domain){
	this.name = name;
	this.domain = domain;
};

/* var logger = function(req, res, next){
	console.log('logging');
	next();

}
app.use(logger);
*/


var search = function(name) {
    
      var temp = "";
      var tempArr= "";

      time = 1000;
      for(var j = 0; j < names.length; j++){
        

		temp = name[j];
        
    
    function got(cName){ https.get('https://www.googleapis.com/customsearch/v1?key='+ key +'&cx=' + custID + '&q=' + temp, function (res){
   
      	res.setEncoding("utf8");

      	var body = "";

      	res.on("data", function(data){
        	body += data;
        
       	});
  
      	res.on("end", function() {
        	body = JSON.parse(body);
          	console.log(body.searchInformation.searchTime);
          
          time += body.searchInformation.searchTime * 1000;
        
        //if (dom.indexOf(body.items[0].link) == -1){
         // dom.push(body.items[0].link);
         // na2.push(cName);
          //compName += '{name: ' + temp+ ', domain: ' + body.items[0].link+ '}, ';
          //tempArr += "name: " + cName + " domain:"  + body.items[0].link;
          
          	returnObj = new data ( cName, body.items[0].link);
          	console.log(returnObj);
          
           // };
        //console.log(tempArr);
      //console.log(dom);
    		});

    	}).on('error', function(err){
      		console.error(err)});
 	     	};
    

        got(temp);

      };
 
 };



var getUrl = function(companyName, callback) {


};

//body-parser
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({extended: false}));


// view engine
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
//set static path
app.use(express.static(path.join(__dirname, 'public')));

/*app.get('/', function(req, res) {
	res.render('index');
	res.sendFile(__dirname + '/views/index.ejs');
});*/
app.get('/', comp.home);
app.post('/', comp.home_post_handler);
app.post('/add', comp.add_handler);
	//console.log(compName);
	// body...

app.get('/api', function(req, res){
	names = req.query["company"];
	
		//search(names);
function search(){	
var temp = "";
      var tempArr= "";

      time = 1000;
      for(var j = 0; j < names.length; j++){
        

	temp = names[j];
        
    
    function got(cName){ https.get('https://www.googleapis.com/customsearch/v1?key='+ key +'&cx=' + custID + '&q=' + temp, function (res){
   
      	res.setEncoding("utf8");

      	var body = "";

      	res.on("data", function(data){
        	body += data;
        
       	});
  
      	res.on("end", function() {
        	body = JSON.parse(body);
          	console.log(body.searchInformation.searchTime);
          
          time += body.searchInformation.searchTime * 1000;
        
        //if (dom.indexOf(body.items[0].link) == -1){
         // dom.push(body.items[0].link);
         // na2.push(cName);
          //compName += '{name: ' + temp+ ', domain: ' + body.items[0].link+ '}, ';
          //tempArr += "name: " + cName + " domain:"  + body.items[0].link;
          
          	returnObj = new data ( cName, body.items[0].link);
          	
          	console.log(returnObj);
          
           // };
        //console.log(tempArr);
      //console.log(dom);
    		});

    	}).on('error', function(err){
      		console.error(err)});
 	     	};
    

        got(temp);

      };
 
 };


 	search(names);
	res.send(JSON.stringify(returnObj));
		
});

app.listen(3000, function(){
	console.log("Server running on 3000");
});