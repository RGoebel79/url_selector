


var dom = [];
const https = require('https');
const custID = '009637816073108880163:nfsysoqnztc';
const key = 'AIzaSyBXGkVilmqEN0KSDAaQy1BlVVIA8r4nS6w';
var na = [];
var compName = "data: [";


exports.home = function(req, res){
  	res.render('index', { title: 'URL Selector', compName: compName, na: na, dom: dom })
};

//handler to add company names to array
exports.add_handler = function(req, res){
	if(na.indexOf(req.body.compN) == -1){
		na.push(req.body.compN);
		console.log(na);
	}
	res.redirect('/');
};

// handler for form submitted from homepage
exports.home_post_handler = function(req, res) {
    
	   	var temp = "";
    	
    	for(var j = 0; j < na.length; j++){
    		
    		
    		temp = na[j];
   
    
   	
   	function got(){ https.get('https://www.googleapis.com/customsearch/v1?key='+ key +'&cx=' + custID + '&q=' + temp, function (res){
	 
  		res.setEncoding("utf8");

  		var body = "";

  		res.on("data", function(data){
    		body += data;
		});
  
  		res.on("end", function() {
    		body = JSON.parse(body);
    			
    		if (dom.indexOf(body.items[0].link) == -1){
    			dom.push(body.items[0].link);
    			compName += '{name: ' + temp+ ', domain: ' + body.items[0].link+ '}, ';
    			console.log(compName);
    				};
    		
			//console.log(dom);
		});

		}).on('error', function(err){
			console.error(err)});
    	};
    

    		got();

   		};
   
   		
   		
   		
    	// redirect the user to homepage
    	res.redirect('/');

    	//console.log(compName + 'done');
};